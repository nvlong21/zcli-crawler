# LLM Prompt Context for Project: Crawler

## Project Overview

*   **Name:** Crawler
*   **Description:** FastAPI project generated by script
*   **Core Framework:** FastAPI
*   **Python Version:** 3.10
*   **Key Concepts:** DDD-Lite (Domain, Application, Infrastructure, Presentation layers), Repository Pattern, Unit of Work (UoW), Dependency Injection (FastAPI Depends), Async/Await.
*   **Features Generated:** orders,users (Comma-separated)
*   **Database:** SQLAlchemy ORM (Check `DATABASE_URL` in `.env` for type - likely async), Alembic for migrations.
*   **Authentication:** JWT (`infrastructure/auth/jwt.py`) with Passlib (`infrastructure/utils/security.py`).
*   **Caching:** Abstracted via `BaseCache`, using Redis or Memory (`infrastructure/cache/`).
*   **External Services:** Abstracted via `BaseClient`, examples for HTTP/gRPC (`infrastructure/external_services/`).
*   **Code Quality:** Ruff (lint/format), MyPy (type check).
## Core File Locations & Purpose

*   **`app/config.py`**: Pydantic settings model, loads from `.env`.
*   **`app/dependencies.py`**: FastAPI dependency providers (DBSession, UoW, Repositories via `get_repo`, Cache, Auth utils, External Clients). Resolves Sync/Async dependencies based on config.
*   **`app/exceptions.py`**: Custom HTTP exception classes.
*   **`presentation/main.py`**: FastAPI app instance, middleware setup, global exception handlers, router includes (look for `# MARKER: Add Feature Router Includes Here`), lifespan manager.
*   **`infrastructure/database/base_model.py`**: SQLAlchemy `Base` class with common columns (timestamps) and metadata.
*   **`infrastructure/database/session.py`**: Creates SQLAlchemy engine and session factories (sync/async).
*   **`infrastructure/repositories/base_repository.py`**: Defines `BaseRepositoryInterface` and `BaseRepository` implementation (handles sync/async session).
*   **`infrastructure/repositories/factory.py`**: Contains `get_repository` factory function and the `_repository_map` (look for `# MARKER: Add Repository Mappings Here`).
*   **`infrastructure/uow/uow.py`**: Defines `AbstractUnitOfWork` and Sync/Async implementations.
*   **`infrastructure/auth/jwt.py`**: JWT creation, decoding, `get_token_payload` dependency.
*   **`infrastructure/auth/permissions.py`**: `require_permission` factory for role-based access control dependencies.
*   **`migrations/env.py`**: Alembic environment script (dynamically imports models).
*   **`pyproject.toml`**: Project dependencies and metadata (Poetry).
*   **`Makefile`**: Common development commands (`make run`, `make test`, `make migrate`, etc.).

## Feature Structure (`<feature_name>`)

Each feature generally follows this structure within `features/<feature_name>/`:

*   **`domain/entities/<feature_name>.py`**: Pydantic model defining the core business entity and its logic.
*   **`domain/value_objects/`**: (Optional) Immutable objects representing descriptive aspects of the domain.
*   **`domain/services/`**: (Optional) Logic involving multiple domain entities.
*   **`app/use_cases/`**: Classes orchestrating actions (e.g., `Create<Feature>UseCase`). They interact with domain objects and use infrastructure interfaces (Repository, UoW) injected via constructor.
*   **`presentation/api/v1/<feature_name>_api.py`**: FastAPI `APIRouter` defining HTTP endpoints, request/response schemas (Pydantic). Endpoints inject and call Use Cases.
*   **`infrastructure/database/models/<feature_name>_model.py`**: SQLAlchemy ORM model mapping to the database table.
*   **`infrastructure/repositories/<feature_name>_repository.py`**: Concrete repository implementation inheriting `BaseRepository`. Registered in the factory.

## Task Example Prompts for LLM

*   "Add a new endpoint `GET /api/v1/users/search?username=<query>` to search for users by username (case-insensitive) using the existing UserRepository. Create a new Use Case `SearchUsersUseCase` in `features/users/app/use_cases/` and update `users_api.py`."
*   "Implement the `list_orders` endpoint in `features/orders/presentation/api/v1/orders_api.py`. Create the corresponding `ListOrdersUseCase` in `features/orders/app/use_cases/`. The endpoint should support pagination using `skip` and `limit` query parameters."
*   "Add a new field `last_login_at: Optional[datetime]` to the `User` domain entity (`features/users/domain/entities/user.py`) and the corresponding SQLAlchemy model (`infrastructure/database/models/user_model.py`). Generate and apply an Alembic migration (`make makemigrations m=\"Add last_login_at to users\"`, `make migrate`). Update the authentication use case (`authenticate_user.py`) to set this field upon successful login."
*   "Refactor the `UserRepository.get_by_email` method to be case-sensitive based on database collation instead of using `ilike`."
*   "Write unit tests for the `CreateUserUseCase` in `tests/unit/users/test_create_user.py`, mocking the repository, UoW, and password hasher."
*   "Write an integration test for the `POST /api/v1/orders/` endpoint in `tests/integration/orders/test_orders_api.py` using FastAPI's TestClient and potentially a test database fixture."

## Current Project Structure

```
.
|____migrations
| |____script.py.mako
| |____env.py
| |____versions
| |______init__.py
|____app
| |____config.py
| |______init__.py
| |____exceptions.py
| |____dependencies.py
|____alembic.ini
|____Dockerfile
|____Makefile
|____features
| |______init__.py
| |____users
| | |____app
| | | |______init__.py
| | | |____use_cases
| | | | |____create_user.py
| | | | |______init__.py
| | | | |____delete_user.py
| | | | |____get_user.py
| | | | |____authenticate_user.py
| | | | |____update_user.py
| | | | |____list_users.py
| | |______init__.py
| | |____domain
| | | |______init__.py
| | | |____entities
| | | | |____user.py
| | | | |______init__.py
| | |____presentation
| | | |______init__.py
| | | |____api
| | | | |____v1
| | | | | |____users_api.py
| | | | | |______init__.py
| | | | | |____auth_api.py
| | | | |______init__.py
| |____orders
| | |____app
| | | |______init__.py
| | | |____use_cases
| | | | |______init__.py
| | | | |____create_orders.py
| | |______init__.py
| | |____domain
| | | |____value_objects
| | | | |______init__.py
| | | |______init__.py
| | | |____services
| | | | |______init__.py
| | | |____entities
| | | | |______init__.py
| | | | |____orders.py
| | |____presentation
| | | |____grpc
| | | | |______init__.py
| | | |______init__.py
| | | |____api
| | | | |____v1
| | | | | |____orders_api.py
| | | | | |______init__.py
| | | | |______init__.py
|____tests
| |____unit
| | |______init__.py
| | |____orders
| |____integration
| | |______init__.py
| | |____orders
| |______init__.py
|______init__.py
|____README.md
|____.env
|____.github
| |____workflows
| | |____ci.yml
| |____README.md
|____infrastructure
| |____middleware
| | |____logging_middleware.py
| | |______init__.py
| |____database
| | |____session.py
| | |______init__.py
| | |____models
| | | |____user_model.py
| | | |______init__.py
| | | |____orders_model.py
| | |____base_model.py
| |____cache
| | |____memory_cache.py
| | |______init__.py
| | |____factory.py
| | |____base_cache.py
| | |____redis_cache.py
| |____grpc
| | |____email.proto
| | |______init__.py
| | |____users.proto
| | |____orders.proto
| |____auth
| | |______init__.py
| | |____permissions.py
| | |____jwt.py
| |______init__.py
| |____utils
| | |____logging_config.py
| | |____security.py
| | |______init__.py
| | |____validation_utils.py
| | |____datetime_utils.py
| |____repositories
| | |____base_repository.py
| | |____orders_repository.py
| | |______init__.py
| | |____factory.py
| | |____user_repository.py
| |____uow
| | |______init__.py
| | |____uow.py
| |____external_services
| | |____clients
| | | |____notification_client.py
| | | |____http_client.py
| | | |____base_client.py
| | | |____grpc_client.py
| | | |______init__.py
| | | |____email_client.py
| | | |____payment_client.py
| | |____config.py
| | |______init__.py
| | |____factory.py
|____presentation
| |____grpc_server.py
| |______init__.py
| |____api
| | |____v1
| | | |______init__.py
| | |______init__.py
| |____main.py
```
