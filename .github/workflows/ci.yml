# GitHub Actions Workflow for CI Pipeline
# Validates code quality, runs tests, and optionally builds artifacts.

name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ] # Trigger on pushes to these branches
  pull_request:
    branches: [ main, master, develop ] # Trigger on pull requests to these branches
  workflow_dispatch: # Allow manual triggering

# Environment variables available to all jobs
env:
  PYTHON_VERSION: "3.9" # Set Python version from template placeholder
  POETRY_VERSION: "1.8.3" # Pin Poetry version for consistency

jobs:
  # Job 1: Code Quality Checks and Tests
  lint-test-typecheck:
    name: Check & Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest # Use latest Ubuntu runner
    strategy:
      fail-fast: false # Allow other matrix jobs to continue if one fails
      matrix:
        # Run checks on the primary target Python version
        python-version: ["3.9"]
        # Optionally add other versions to test compatibility:
        # python-version: ["3.9", "3.10", "3.11"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
           fetch-depth: 0 # Fetch all history for analysis tools if needed

      - name: Set up Python ${{ matrix.python-version }}
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        run: pipx install poetry==${{ env.POETRY_VERSION }}

      - name: Configure Poetry cache path
        id: poetry-cache-path
        run: echo "dir=$(poetry config cache-dir)" >> $GITHUB_OUTPUT

      - name: Set up Poetry cache
        uses: actions/cache@v4
        id: poetry-cache # Cache Poetry virtualenv and package cache
        with:
          path: ${{ steps.poetry-cache-path.outputs.dir }}
          key: ${{ runner.os }}-poetry-${{ env.POETRY_VERSION }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-${{ env.POETRY_VERSION }}-

      - name: Install dependencies using Poetry
        run: poetry install --no-interaction --no-root # Install only dependencies, not the project itself

      - name: Lint with Ruff
        run: poetry run ruff check .

      - name: Format Check with Ruff
        run: poetry run ruff format --check .

      - name: Static Type Check with MyPy
        # Consider running only on primary Python version if slow
        # if: matrix.python-version == env.PYTHON_VERSION
        run: poetry run mypy .

      - name: Run tests with Pytest and Coverage
        run: |
          poetry run pytest \
            -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            tests/

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v4
        env:
           CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }} # Required secret in GitHub repo settings
        with:
           # Optional: Specify flags for Codecov report grouping
           # flags: unittests,py${{ matrix.python-version }}
           files: ./coverage.xml # Path to coverage report
           fail_ci_if_error: true # Fail CI job if Codecov upload fails
           verbose: true # Enable verbose logging for debugging

  # Job 2: Optional - Build Docker Image
  build-docker:
    name: Build Docker Image
    needs: lint-test-typecheck # Run only if checks and tests pass
    # Trigger conditions (e.g., only on push to main branch)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # Needed if pushing to GitHub Package Registry

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Example: Login to Docker Hub (requires secrets)
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Example: Login to GitHub Container Registry
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # Use default GITHUB_TOKEN

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          # Image name examples:
          images: |
            ghcr.io/${{ github.repository_owner }}/my_fastapi_project
            # your-dockerhub-username/my_fastapi_project
          tags: |
            # tag latest on default branch pushes
            type=raw,value=latest,enable={{is_default_branch}}
            # tag with git sha
            type=sha,prefix=,suffix=,format=short
            # tag with git ref (branch or tag name)
            type=ref,event=branch
            type=ref,event=tag
            type=ref,event=pr

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true # Set to true to push to registry after successful build
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha # Enable GitHub Actions cache for Docker layers
          cache-to: type=gha,mode=max
          # Pass Python version as build argument to Dockerfile
          build-args: |
            PYTHON_VERSION=${{ env.PYTHON_VERSION }}
